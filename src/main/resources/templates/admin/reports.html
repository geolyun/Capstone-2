<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <title>관리자 - 신고 대시보드</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <meta name="_csrf" th:content="${_csrf?.token}"/>
    <meta name="_csrf_header" th:content="${_csrf?.headerName}"/>
</head>
<body>
<div th:replace="~{layout/header :: header}"></div>
<main class="container mt-5">
    <h2>미처리 신고 목록</h2>
    <table class="table">
        <thead>
        <tr>
            <th>신고 ID</th>
            <th>신고된 코스</th>
            <th>신고 사유</th>
            <th>신고자</th>
            <th>신고일</th>
            <th>처리</th>
        </tr>
        </thead>
        <tbody>
        <tr th:each="report : ${reportPage.content}">
            <td th:text="${report.reportId}"></td>
            <td th:text="${report.reportedCourseTitle}"></td>
            <td th:text="${report.reason}"></td>
            <td th:text="${report.reporterNickname}"></td>
            <td th:text="${#temporals.format(report.createdAt, 'yyyy-MM-dd HH:mm')}"></td>
            <td>
                <button class="btn btn-primary btn-sm"
                        th:attr="data-report-id=${report.reportId}"
                        onclick="resolveReport(this)">처리하기</button>
            </td>
        </tr>
        </tbody>
    </table>
</main>

<script th:inline="javascript">
    async function resolveReport(button) {
        const reportId = button.getAttribute('data-report-id');
        if (!confirm(reportId + ' 신고를 처리 완료하시겠습니까?')) {
            return;
        }

        const csrfToken = document.querySelector('meta[name="_csrf"]').content;
        const csrfHeader = document.querySelector('meta[name="_csrf_header"]').content;

        try {
            button.disabled = true;
            button.textContent = '처리 중...';

            const response = await fetch(`/api/admin/reports/${reportId}/resolve`, {
                method: 'POST',
                headers: {
                    [csrfHeader]: csrfToken,
                    'Accept': 'application/json'
                }
            });

            if (response.ok) {
                alert('신고가 처리되었습니다.');
                // 버튼을 비활성화하거나 행을 제거
                button.textContent = '처리 완료';
                button.classList.remove('btn-primary');
                button.classList.add('btn-secondary');
            } else {
                alert('신고 처리 중 오류 발생: ' + response.status);
                button.disabled = false;
                button.textContent = '처리하기';
            }
        } catch (error) {
            console.error('Resolve report error:', error);
            alert('네트워크 오류가 발생했습니다.');
            button.disabled = false;
            button.textContent = '처리하기';
        }
    }
</script>

</body>
</html>