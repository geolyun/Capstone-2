<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>코스 수정</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .spot-item { border: 1px solid #eee; padding: 15px; margin-bottom: 15px; border-radius: 5px; position: relative; }
        .remove-spot-btn { position: absolute; top: 10px; right: 10px; }
    </style>
</head>
<body>
<div th:replace="~{layout/header :: header}"></div>

<main class="container mt-5 mb-5">
    <h2>코스 수정</h2>
    <hr>
    <form th:action="@{/courses/{id}/edit(id=${courseId})}" th:object="${course}" method="post">

        <div th:if="${errorMessage}" class="alert alert-danger" role="alert" th:text="${errorMessage}"></div>
        <div th:if="${#fields.hasGlobalErrors()}" class="alert alert-danger" role="alert">
            <ul>
                <li th:each="err : ${#fields.globalErrors()}" th:text="${err}"></li>
            </ul>
        </div>

        <div class="mb-3">
            <label for="title" class="form-label">코스 제목 <span class="text-danger">*</span></label>
            <input type="text" id="title" th:field="*{title}" class="form-control" th:errorclass="is-invalid" required>
            <div th:if="${#fields.hasErrors('title')}" th:errors="*{title}" class="invalid-feedback"></div>
        </div>
        <div class="mb-3">
            <label for="category" class="form-label">카테고리</label>
            <select th:field="*{categoryId}" id="category" class="form-select">
                <option value="">카테고리를 선택하세요</option>
                <optgroup th:each="entry : ${categoryMap}" th:label="${entry.key}">
                    <option th:each="child : ${entry.value}"
                            th:value="${child.id}"
                            th:text="${child.name}">소분류</option>
                </optgroup>
            </select>
        </div>
        <div class="mb-3">
            <label for="summary" class="form-label">한 줄 요약</label>
            <textarea id="summary" th:field="*{summary}" class="form-control" th:errorclass="is-invalid" rows="2"></textarea>
            <div th:if="${#fields.hasErrors('summary')}" th:errors="*{summary}" class="invalid-feedback"></div>
        </div>

        <div class="mb-3">
            <label for="coverImageFile" class="form-label">커버 이미지</label>
            <input type="file" id="coverImageFile" class="form-control" accept="image/*">
            <input type="hidden" id="coverImageUrl" th:field="*{coverImageUrl}">
            <img id="cover-preview" th:src="${course.coverImageUrl != null ? course.coverImageUrl : '#'}" alt="커버 이미지 미리보기" class="mt-2 img-thumbnail" th:style="${course.coverImageUrl != null ? 'max-width: 200px; display: block;' : 'max-width: 200px; display: none;'}"/>
            <div id="cover-upload-status" class="form-text mt-1"></div>
        </div>

        <div class="row">
            <div class="col-md-6 mb-3">
                <label for="regionName" class="form-label">지역명</label>
                <input type="text" id="regionName" th:field="*{regionName}" class="form-control" th:errorclass="is-invalid">
                <div th:if="${#fields.hasErrors('regionName')}" th:errors="*{regionName}" class="invalid-feedback"></div>
            </div>
            <div class="col-md-6 mb-3">
                <label for="regionCode" class="form-label">지역 코드 (선택)</label>
                <input type="text" id="regionCode" th:field="*{regionCode}" class="form-control" th:errorclass="is-invalid">
                <div th:if="${#fields.hasErrors('regionCode')}" th:errors="*{regionCode}" class="invalid-feedback"></div>
            </div>
        </div>
        <div class="row">
            <div class="col-md-6 mb-3">
                <label for="durationMinutes" class="form-label">예상 소요 시간 (분)</label>
                <input type="number" id="durationMinutes" th:field="*{durationMinutes}" class="form-control" th:errorclass="is-invalid">
                <div th:if="${#fields.hasErrors('durationMinutes')}" th:errors="*{durationMinutes}" class="invalid-feedback"></div>
            </div>
            <div class="col-md-6 mb-3">
                <label for="estimatedCost" class="form-label">예상 비용 (원)</label>
                <input type="number" id="estimatedCost" th:field="*{estimatedCost}" class="form-control" th:errorclass="is-invalid">
                <div th:if="${#fields.hasErrors('estimatedCost')}" th:errors="*{estimatedCost}" class="invalid-feedback"></div>
            </div>
        </div>

        <div class="mb-3">
            <label for="tagsString" class="form-label">태그 (쉼표로 구분)</label>
            <input type="text" id="tagsString" th:field="*{tagsString}" class="form-control" th:errorclass="is-invalid" placeholder="예: 서울, 맛집, 데이트">
            <div th:if="${#fields.hasErrors('tagsString')}" th:errors="*{tagsString}" class="invalid-feedback"></div>
        </div>


        <hr>
        <h4>코스 스팟 수정 <span class="text-danger">*</span></h4>
        <div id="spots-container">
            <div th:each="spot, stat : *{spots}" class="spot-item">
                <input type="hidden" th:field="*{spots[__${stat.index}__].orderNo}" th:value="${stat.index + 1}">
                <div class="mb-2">
                    <label class="form-label">스팟 <span class="spot-number" th:text="${stat.index + 1}">1</span> 제목 <span class="text-danger">*</span></label>
                    <input type="text" th:field="*{spots[__${stat.index}__].title}" class="form-control spot-title">
                </div>
                <div class="mb-2">
                    <label class="form-label">설명</label>
                    <textarea th:field="*{spots[__${stat.index}__].description}" class="form-control" rows="2"></textarea>
                </div>
                <div class="row">
                    <div class="col-md-6 mb-2">
                        <label class="form-label">위도</label>
                        <input type="number" step="any" th:field="*{spots[__${stat.index}__].lat}" class="form-control">
                    </div>
                    <div class="col-md-6 mb-2">
                        <label class="form-label">경도</label>
                        <input type="number" step="any" th:field="*{spots[__${stat.index}__].lng}" class="form-control">
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6 mb-2">
                        <label class="form-label">추천 체류 시간 (분)</label>
                        <input type="number" th:field="*{spots[__${stat.index}__].stayMinutes}" class="form-control">
                    </div>
                    <div class="col-md-6 mb-2">
                        <label class="form-label">가격 (원)</label>
                        <input type="number" th:field="*{spots[__${stat.index}__].price}" class="form-control">
                    </div>
                </div>
                <div class="mb-2">
                    <label class="form-label">이미지 URL (쉼표 구분)</label>
                    <input type="text" th:attr="name='spots[' + ${stat.index} + '].imagesInput'" th:value="${#strings.listJoin(spot.images, ',')}" class="form-control spot-images-input">
                    <input type="hidden" th:field="*{spots[__${stat.index}__].images}">
                </div>
                <button type="button" class="btn btn-danger btn-sm remove-spot-btn">스팟 삭제</button>
            </div>
        </div>
        <div class="spot-item-template d-none">
            <div class="spot-item">
                <input type="hidden" name="spots[__index__].orderNo" value="__indexPlusOne__" disabled>
                <div class="mb-2">
                    <label class="form-label">스팟 <span class="spot-number">__indexPlusOne__</span> 제목 <span class="text-danger">*</span></label>
                    <input type="text" name="spots[__index__].title" class="form-control spot-title" disabled> </div>
                <div class="mb-2">
                    <label class="form-label">설명</label>
                    <textarea name="spots[__index__].description" class="form-control" rows="2" disabled></textarea>
                </div>
                <div class="row">
                    <div class="col-md-6 mb-2">
                        <label class="form-label">위도</label>
                        <input type="number" step="any" name="spots[__index__].lat" class="form-control" disabled>
                    </div>
                    <div class="col-md-6 mb-2">
                        <label class="form-label">경도</label>
                        <input type="number" step="any" name="spots[__index__].lng" class="form-control" disabled>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6 mb-2">
                        <label class="form-label">추천 체류 시간 (분)</label>
                        <input type="number" name="spots[__index__].stayMinutes" class="form-control" disabled>
                    </div>
                    <div class="col-md-6 mb-2">
                        <label class="form-label">가격 (원)</label>
                        <input type="number" name="spots[__index__].price" class="form-control" disabled>
                    </div>
                </div>
                <div class="mb-2">
                    <label class="form-label">이미지 URL (쉼표 구분)</label>
                    <input type="text" name="spots[__index__].imagesInput" class="form-control spot-images-input" disabled>
                    <input type="hidden" name="spots[__index__].images" disabled>
                </div>
                <button type="button" class="btn btn-danger btn-sm remove-spot-btn">스팟 삭제</button>
            </div>
        </div>
        <button type="button" id="add-spot-btn" class="btn btn-secondary mt-2">스팟 추가</button>
        <div th:if="${#fields.hasErrors('spots')}" class="alert alert-danger mt-2" role="alert">
            <span th:errors="*{spots}"></span>
        </div>


        <hr>
        <button type="submit" class="btn btn-primary">코스 수정하기</button>
        <a th:href="@{/courses/{id}(id=${courseId})}" class="btn btn-secondary">취소</a>
    </form>
</main>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
    // --- 커버 이미지 업로드 로직 (기존과 동일) ---
    const coverImageFile = document.getElementById('coverImageFile');
    const coverPreview = document.getElementById('cover-preview');
    const coverImageUrlInput = document.getElementById('coverImageUrl');
    const coverUploadStatus = document.getElementById('cover-upload-status');

    coverImageFile.addEventListener('change', async (event) => {
        const file = event.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (e) => { coverPreview.src = e.target.result; coverPreview.style.display = 'block'; };
        reader.readAsDataURL(file);
        const formData = new FormData();
        formData.append('file', file);
        coverUploadStatus.textContent = '업로드 중...';
        coverUploadStatus.classList.remove('text-success', 'text-danger');
        try {
            const response = await fetch('/api/files/upload', { method: 'POST', body: formData });
            if (!response.ok) throw new Error('Upload failed');
            const result = await response.json();
            coverImageUrlInput.value = result.url;
            coverUploadStatus.textContent = '업로드 성공!';
            coverUploadStatus.classList.add('text-success');
        } catch (error) {
            console.error('Cover upload error:', error);
            coverUploadStatus.textContent = '업로드 실패.';
            coverUploadStatus.classList.add('text-danger');
            coverImageFile.value = '';
            // 실패 시 기존 이미지 유지 또는 기본 이미지로 변경 결정 필요
            // coverPreview.src = coverImageUrlInput.value || '#';
            // coverPreview.style.display = coverImageUrlInput.value ? 'block' : 'none';
        }
    });

    // --- 스팟 추가/삭제 로직 ---
    const spotsContainer = document.getElementById('spots-container');
    const addSpotBtn = document.getElementById('add-spot-btn');
    const spotTemplate = document.querySelector('.spot-item-template');
    // 페이지 로드 시 기존 스팟 개수를 기반으로 초기 인덱스 설정
    let spotIndex = spotsContainer.querySelectorAll('.spot-item').length;

    // 이미지 input(text) 변경 시 hidden input(List<String>) 업데이트하는 함수
    function updateSpotImagesHiddenInput(imagesInput) {
        const spotItem = imagesInput.closest('.spot-item');
        const hiddenImagesInput = spotItem.querySelector('input[type="hidden"][name$=".images"]');
        if (hiddenImagesInput) {
            // 쉼표로 분리하고 앞뒤 공백 제거 후 빈 문자열 필터링
            const imageUrls = imagesInput.value.split(',')
                .map(url => url.trim())
                .filter(url => url);
            // Thymeleaf List 바인딩을 위해 각 URL을 별도의 파라미터로 만들어야 함
            // 예: spots[0].images=url1&spots[0].images=url2
            // 이 로직은 복잡해지므로, 서버 측에서 쉼표 구분 문자열을 파싱하는 것이 더 간단할 수 있음.
            // 여기서는 우선 hidden input에 JSON 배열 형태의 문자열로 저장하는 방식을 사용 (서버측 수정 필요)
            // hiddenImagesInput.value = JSON.stringify(imageUrls);

            // **대안: Thymeleaf List 바인딩 방식 유지**
            // JavaScript로 hidden input 여러 개를 동적으로 생성/관리해야 함
            // 이 예제에서는 단순화를 위해 쉼표 구분 문자열 처리 방식을 유지하고,
            // 서버(CourseServiceImpl)에서 이 문자열을 파싱하도록 수정하는 것을 가정합니다.
            // -> CourseServiceImpl의 processFormFields에서 이 부분을 처리하도록 합니다.
            //    따라서 여기서는 별도 처리가 필요 없습니다.
            //    대신, hidden input은 List<String> 바인딩을 위해 남겨둡니다.
            //    JS는 addSpot 시 hidden input도 복제하고 name 설정하는 것을 확인해야 합니다.
        }
    }


    function addSpot() {
        const newSpot = spotTemplate.cloneNode(true);
        newSpot.classList.remove('spot-item-template', 'd-none');
        // 인덱스 교체 (__index__, __indexPlusOne__)
        newSpot.innerHTML = newSpot.innerHTML.replace(/__index__/g, spotIndex).replace(/__indexPlusOne__/g, spotIndex + 1);

        newSpot.querySelectorAll('input, textarea, select').forEach(input => {
            input.disabled = false;
            // name 속성도 여기서 최종 설정
            // input.name = input.name.replace('__index__', spotIndex); // innerHTML replace에서 처리됨

            // 이미지 input 이벤트 리스너 추가 (입력 시 hidden 필드 업데이트 용도였으나 현재 방식에선 불필요)
            // if (input.classList.contains('spot-images-input')) {
            //     input.addEventListener('input', () => updateSpotImagesHiddenInput(input));
            // }
        });

        // 추가된 스팟의 히든 이미지 필드 이름도 설정
        const hiddenImages = newSpot.querySelector('input[type="hidden"][name$=".images"]');
        if(hiddenImages) {
            hiddenImages.name = `spots[${spotIndex}].images`;
            hiddenImages.disabled = false; // 히든 필드 활성화
        }


        spotsContainer.appendChild(newSpot);

        newSpot.querySelector('.remove-spot-btn').addEventListener('click', (e) => {
            e.target.closest('.spot-item').remove();
            reindexSpots();
        });

        spotIndex++;
    }

    function reindexSpots() {
        const spotItems = spotsContainer.querySelectorAll('.spot-item');
        let currentIdx = 0;
        spotItems.forEach((item) => {
            item.querySelector('.spot-number').textContent = currentIdx + 1;
            item.querySelector('input[name$=\\.orderNo]').value = currentIdx + 1;

            // 모든 input/textarea/select의 name 인덱스 업데이트
            item.querySelectorAll('[name*="spots["]').forEach(input => {
                input.name = input.name.replace(/spots\[\d+\]/, `spots[${currentIdx}]`);
            });
            currentIdx++;
        });
        spotIndex = currentIdx; // 다음 추가될 인덱스 업데이트
    }

    addSpotBtn.addEventListener('click', addSpot);

    // 페이지 로드 시 기존 스팟의 이미지 input 이벤트 리스너 추가 (입력 시 hidden 필드 업데이트 용도였으나 현재 방식에선 불필요)
    // document.querySelectorAll('.spot-images-input').forEach(input => {
    //    input.addEventListener('input', () => updateSpotImagesHiddenInput(input));
    // });

    // 페이지 로드 시, Thymeleaf가 렌더링한 List<String> images 필드를 기반으로
    // 사용자에게 보여줄 imagesInput(쉼표 구분 문자열) 필드를 초기화합니다.
    // (이 로직은 UpdateReq DTO 변환 시 tagsString, metadataJson처럼 서버에서 미리 처리하는 것이 더 좋음)
    document.querySelectorAll('.spot-item:not(.spot-item-template)').forEach(item => {
        const hiddenImagesInputs = item.querySelectorAll('input[type="hidden"][name$=".images"]');
        const imagesInput = item.querySelector('input.spot-images-input');
        if (hiddenImagesInputs.length > 0 && imagesInput) {
            const urls = Array.from(hiddenImagesInputs).map(input => input.value);
            imagesInput.value = urls.join(', ');
            // 이제 List<String> 바인딩용 hidden input은 제거해도 되지만,
            // Thymeleaf 바인딩을 위해 남겨두고 JS로 관리하거나,
            // 서버에서 imagesInput 문자열을 파싱하는 방식으로 변경 필요.
            // 여기서는 서버 파싱 방식을 가정하고 hidden input은 유지.
        }
    });


    // 수정 페이지 로드 시, 만약 스팟이 하나도 없다면 기본 1개 추가
    if (spotIndex === 0) {
        addSpot();
    }

</script>
</body>
</html>