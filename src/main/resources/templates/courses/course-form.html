<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>새 코스 만들기</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        /* 간단한 스팟 구분 스타일 */
        .spot-item { border: 1px solid #eee; padding: 15px; margin-bottom: 15px; border-radius: 5px; position: relative; }
        .remove-spot-btn { position: absolute; top: 10px; right: 10px; }
    </style>
</head>
<body>
<div th:replace="~{layout/header :: header}"></div>

<main class="container mt-5 mb-5">
    <h2>새 코스 만들기</h2>

    <div class="mb-3 p-3 border rounded bg-light">
        <label classs="form-label fw-bold">추천 템플릿으로 시작하기:</label>
        <div id="template-buttons" class="mt-2 d-flex flex-wrap gap-2">
            <span class="text-muted">템플릿 로딩 중...</span>
        </div>
    </div>

    <hr>
    <form th:action="@{/courses}" th:object="${course}" method="post">

        <div th:if="${errorMessage}" class="alert alert-danger" role="alert" th:text="${errorMessage}"></div>
        <div th:if="${#fields.hasGlobalErrors()}" class="alert alert-danger" role="alert">
            <ul>
                <li th:each="err : ${#fields.globalErrors()}" th:text="${err}"></li>
            </ul>
        </div>

        <div class="mb-3">
            <label for="title" class="form-label">코스 제목 <span class="text-danger">*</span></label>
            <input type="text" id="title" th:field="*{title}" class="form-control" th:errorclass="is-invalid" required>
            <div th:if="${#fields.hasErrors('title')}" th:errors="*{title}" class="invalid-feedback"></div>
        </div>
        <div class="mb-3">
            <label for="summary" class="form-label">한 줄 요약</label>
            <textarea id="summary" th:field="*{summary}" class="form-control" th:errorclass="is-invalid" rows="2"></textarea>
            <div th:if="${#fields.hasErrors('summary')}" th:errors="*{summary}" class="invalid-feedback"></div>
        </div>

        <div class="mb-3">
            <label for="coverImageFile" class="form-label">커버 이미지</label>
            <input type="file" id="coverImageFile" class="form-control" accept="image/*">
            <input type="hidden" id="coverImageUrl" th:field="*{coverImageUrl}">
            <img id="cover-preview" src="#" alt="커버 이미지 미리보기" class="mt-2 img-thumbnail" style="max-width: 200px; display: none;"/>
            <div id="cover-upload-status" class="form-text mt-1"></div>
        </div>

        <div class="row">
            <div class="col-md-6 mb-3">
                <label for="regionName" class="form-label">지역명</label>
                <input type="text" id="regionName" th:field="*{regionName}" class="form-control" th:errorclass="is-invalid">
                <div th:if="${#fields.hasErrors('regionName')}" th:errors="*{regionName}" class="invalid-feedback"></div>
            </div>
            <div class="col-md-6 mb-3">
                <label for="regionCode" class="form-label">지역 코드 (선택)</label>
                <input type="text" id="regionCode" th:field="*{regionCode}" class="form-control" th:errorclass="is-invalid">
                <div th:if="${#fields.hasErrors('regionCode')}" th:errors="*{regionCode}" class="invalid-feedback"></div>
            </div>
        </div>
        <div class="row">
            <div class="col-md-6 mb-3">
                <label for="durationMinutes" class="form-label">예상 소요 시간 (분)</label>
                <input type="number" id="durationMinutes" th:field="*{durationMinutes}" class="form-control" th:errorclass="is-invalid">
                <div th:if="${#fields.hasErrors('durationMinutes')}" th:errors="*{durationMinutes}" class="invalid-feedback"></div>
            </div>
            <div class="col-md-6 mb-3">
                <label for="estimatedCost" class="form-label">예상 비용 (원)</label>
                <input type="number" id="estimatedCost" th:field="*{estimatedCost}" class="form-control" th:errorclass="is-invalid">
                <div th:if="${#fields.hasErrors('estimatedCost')}" th:errors="*{estimatedCost}" class="invalid-feedback"></div>
            </div>
        </div>

        <div class="mb-3">
            <label for="tagsString" class="form-label">태그 (쉼표로 구분)</label>
            <input type="text" id="tagsString" th:field="*{tagsString}" class="form-control" th:errorclass="is-invalid" placeholder="예: 서울, 맛집, 데이트">
            <div th:if="${#fields.hasErrors('tagsString')}" th:errors="*{tagsString}" class="invalid-feedback"></div>
        </div>

        <hr>
        <h4>코스 스팟 등록 <span class="text-danger">*</span></h4>
        <div id="spots-container">
        </div>
        <div class="spot-item-template d-none">
            <div class="spot-item">
                <input type="hidden" name="spots[__index__].orderNo" value="__indexPlusOne__" disabled>
                <div class="mb-2">
                    <label class="form-label">스팟 <span class="spot-number">__indexPlusOne__</span> 제목 <span class="text-danger">*</span></label>
                    <input type="text" name="spots[__index__].title" class="form-control spot-title" disabled> </div>
                <div class="mb-2">
                    <label class="form-label">설명</label>
                    <textarea name="spots[__index__].description" class="form-control" rows="2" disabled></textarea>
                </div>
                <div class="row">
                    <div class="col-md-6 mb-2">
                        <label class="form-label">위도</label>
                        <input type="number" step="any" name="spots[__index__].lat" class="form-control" disabled>
                    </div>
                    <div class="col-md-6 mb-2">
                        <label class="form-label">경도</label>
                        <input type="number" step="any" name="spots[__index__].lng" class="form-control" disabled>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6 mb-2">
                        <label class="form-label">추천 체류 시간 (분)</label>
                        <input type="number" name="spots[__index__].stayMinutes" class="form-control" disabled>
                    </div>
                    <div class="col-md-6 mb-2">
                        <label class="form-label">가격 (원)</label>
                        <input type="number" name="spots[__index__].price" class="form-control" disabled>
                    </div>
                </div>
                <div class="mb-2">
                    <label class="form-label">이미지 URL (쉼표 구분)</label>
                    <input type="text" name="spots[__index__].images" class="form-control spot-images-input" disabled>
                </div>
                <button type="button" class="btn btn-danger btn-sm remove-spot-btn">스팟 삭제</button>
            </div>
        </div>
        <button type="button" id="add-spot-btn" class="btn btn-secondary mt-2">스팟 추가</button>
        <div th:if="${#fields.hasErrors('spots')}" class="alert alert-danger mt-2" role="alert">
            <span th:errors="*{spots}"></span>
        </div>


        <hr>
        <button type="submit" class="btn btn-primary">코스 등록하기</button>
        <a href="/home" class="btn btn-secondary">취소</a>
    </form>
</main>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
    // --- 커버 이미지 업로드 로직 ---
    const coverImageFile = document.getElementById('coverImageFile');
    const coverPreview = document.getElementById('cover-preview');
    const coverImageUrlInput = document.getElementById('coverImageUrl');
    const coverUploadStatus = document.getElementById('cover-upload-status');

    coverImageFile.addEventListener('change', async (event) => {
        const file = event.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (e) => { coverPreview.src = e.target.result; coverPreview.style.display = 'block'; };
        reader.readAsDataURL(file);
        const formData = new FormData();
        formData.append('file', file);
        coverUploadStatus.textContent = '업로드 중...';
        coverUploadStatus.classList.remove('text-success', 'text-danger');
        try {
            const response = await fetch('/api/files/upload', { method: 'POST', body: formData });
            if (!response.ok) throw new Error('Upload failed');
            const result = await response.json();
            coverImageUrlInput.value = result.url;
            coverUploadStatus.textContent = '업로드 성공!';
            coverUploadStatus.classList.add('text-success');
        } catch (error) {
            console.error('Cover upload error:', error);
            coverUploadStatus.textContent = '업로드 실패.';
            coverUploadStatus.classList.add('text-danger');
            coverImageFile.value = '';
            coverPreview.style.display = 'none';
        }
    });

    // --- 스팟 추가/삭제 로직 ---
    const spotsContainer = document.getElementById('spots-container');
    const addSpotBtn = document.getElementById('add-spot-btn');
    const spotTemplate = document.querySelector('.spot-item-template');
    let spotIndex = 0;

    function addSpot() {
        const newSpot = spotTemplate.cloneNode(true);
        newSpot.classList.remove('spot-item-template', 'd-none');
        // 인덱스 교체 (__index__, __indexPlusOne__)
        newSpot.innerHTML = newSpot.innerHTML.replace(/__index__/g, spotIndex).replace(/__indexPlusOne__/g, spotIndex + 1);

        // name 속성 최종 설정 (Thymeleaf List 바인딩)
        newSpot.querySelectorAll('input, textarea, select').forEach(input => {
            input.disabled = false;
            // name 속성도 여기서 최종 설정
            input.name = input.name.replace('__index__', spotIndex);
        });

        spotsContainer.appendChild(newSpot);

        // 삭제 버튼 이벤트 리스너 추가
        newSpot.querySelector('.remove-spot-btn').addEventListener('click', (e) => {
            e.target.closest('.spot-item').remove();
            // 스팟 삭제 후 순서(orderNo) 및 name 인덱스 재정렬 필요
            reindexSpots();
        });

        spotIndex++; // 다음 스팟 인덱스 증가
    }

    // 스팟 삭제 시 name 인덱스 재정렬 함수
    function reindexSpots() {
        const spotItems = spotsContainer.querySelectorAll('.spot-item');
        spotIndex = 0; // 인덱스 초기화
        spotItems.forEach((item) => {
            item.querySelector('.spot-number').textContent = spotIndex + 1; // 보이는 숫자 업데이트
            item.querySelector('input[name$=\\.orderNo]').value = spotIndex + 1; // orderNo 값 업데이트

            // 모든 input/textarea의 name 인덱스 업데이트
            item.querySelectorAll('[name*="spots["]').forEach(input => {
                input.name = input.name.replace(/spots\[\d+\]/, `spots[${spotIndex}]`);
            });
            spotIndex++;
        });
    }

    document.addEventListener('DOMContentLoaded', () => {
        loadRecommendationTemplates();
    });

    // 1. 템플릿 목록을 서버에서 불러와 버튼 생성
    async function loadRecommendationTemplates() {
        const container = document.getElementById('template-buttons');
        try {
            // ✅ 수정된 컨트롤러 경로로 fetch
            const response = await fetch('/courses/recommendation-templates');
            if (!response.ok) throw new Error('템플릿 로드 실패');

            const templates = await response.json();
            container.innerHTML = ''; // "로딩 중..." 텍스트 제거

            templates.forEach(template => {
                const button = document.createElement('button');
                button.type = 'button';
                button.className = 'btn btn-outline-primary btn-sm';
                button.textContent = template.title;
                // 3. 버튼 클릭 시 applyTemplate 함수 호출
                button.addEventListener('click', () => applyTemplate(template));
                container.appendChild(button);
            });
        } catch (error) {
            console.error('Template load error:', error);
            container.innerHTML = '<span class="text-danger">템플릿을 불러오지 못했습니다.</span>';
        }
    }

    // 2. 템플릿 데이터를 폼에 적용하는 함수
    function applyTemplate(template) {
        // 기본 정보 채우기
        document.getElementById('title').value = template.title;
        document.getElementById('summary').value = template.summary;

        // 스팟 정보 채우기 (기존 addSpot 함수 재활용)
        spotsContainer.innerHTML = ''; // 기존 스팟 모두 삭제
        spotIndex = 0; // 스팟 인덱스 초기화

        if (template.spots && template.spots.length > 0) {
            template.spots.forEach(spotData => {
                // 템플릿에 스팟이 있으면 addSpot() 호출
                addSpot();

                // addSpot()으로 방금 생성된 마지막 스팟 아이템을 찾음
                const lastSpotItem = spotsContainer.lastElementChild;
                if (lastSpotItem) {
                    // 스켈레톤 데이터 채우기
                    lastSpotItem.querySelector('input[name$=".title"]').value = spotData.title || '';
                    lastSpotItem.querySelector('textarea[name$=".description"]').value = spotData.description || '';
                    lastSpotItem.querySelector('input[name$=".stayMinutes"]').value = spotData.stayMinutes || '';
                    lastSpotItem.querySelector('input[name$=".price"]').value = spotData.price || '';
                    // (위도, 경도, 이미지 등은 템플릿에 없으므로 비워둠)
                }
            });
        } else {
            // 템플릿에 스팟이 없으면, 기본 1개만 추가
            addSpot();
        }
    }

    addSpotBtn.addEventListener('click', addSpot);

    // 페이지 로드 시 기본 스팟 1개 추가
    addSpot();
</script>
</body>
</html>